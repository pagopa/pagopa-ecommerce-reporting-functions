name: Trigger pipeline deploy

on:
  release:
    types: [published]

permissions:
  contents: read
  pull-requests: read

jobs:
  azure-devops-deploy-pipeline:
    name: Trigger azure devops deploy pipeline
    runs-on: ubuntu-latest
    environment: prod
    steps:
      - name: Configure pipeline parameters
        id: configure_pipeline_parameters
        run: |
          echo "📝 Inputs"
          echo "pull request merged: ${{ github.event.pull_request.merged}}"
          echo "ENV=prod" >> $GITHUB_OUTPUT
          echo "FORCE_REPLACE_DOCKER_IMAGE=False" >> $GITHUB_OUTPUT
        shell: bash
      - name: Log pipeline parameters
        run: |
          echo "🪛 Pipeline parameters"
          echo "ENV=${{ steps.configure_pipeline_parameters.outputs.ENV }}"
          echo "FORCE_REPLACE_DOCKER_IMAGE=${{ steps.configure_pipeline_parameters.outputs.FORCE_REPLACE_DOCKER_IMAGE }}"
        shell: bash
      - name: Azure Pipelines Action
        uses: jacopocarlini/azure-pipelines@v1.3
        with:
          azure-devops-project-url: https://dev.azure.com/pagopaspa/pagoPA-projects
          azure-pipeline-name: 'pagopa-ecommerce-reporting-functions.deploy'
          azure-devops-token: ${{ secrets.AZURE_DEVOPS_TOKEN }}
          azure-template-parameters: |
            {
                "ENV": "${{ steps.configure_pipeline_parameters.outputs.ENV }}",
                "FORCE_REPLACE_DOCKER_IMAGE": "${{ steps.configure_pipeline_parameters.outputs.FORCE_REPLACE_DOCKER_IMAGE }}",
            }